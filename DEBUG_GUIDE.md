# 調試指南 - 歷史記錄和排行榜問題

## 問題分析

根據您提供的日誌分析，我們發現了問題的根本原因：

### 🔍 主要問題
1. **Firestore 索引缺失**：查詢 `gameRecords` 集合時需要複合索引
2. **查詢邏輯複雜**：使用了 `orderBy` + `where` 的組合查詢
3. **錯誤處理不足**：當查詢失敗時沒有降級方案

### 📊 日誌分析結果
```
FirebaseError: The query requires an index. You can create it here: 
https://console.firebase.google.com/v1/r/project/tetris-game-bb11f/firestore/indexes?create_composite=...
```

## 🛠️ 已實施的修復

### 1. 查詢邏輯優化
- **移除複合查詢**：不再使用 `orderBy('playedAt', 'desc')` 和 `where('userId', '==', userId)` 的組合
- **客戶端排序**：在獲取數據後在客戶端進行排序
- **降級查詢**：當主查詢失敗時，自動嘗試更簡單的查詢

### 2. 錯誤處理增強
- **詳細日誌**：添加了完整的調試信息
- **多層降級**：提供多個查詢方案
- **優雅失敗**：即使查詢失敗也不會破壞應用

### 3. 性能優化
- **智能限制**：獲取適量數據進行客戶端處理
- **快取機制**：減少重複查詢

## 🧪 測試步驟

### 立即測試（無需索引）

1. **打開應用程式**
   ```
   http://localhost:5173/
   ```

2. **打開瀏覽器控制台**
   - 按 `F12` 打開開發者工具
   - 切換到 "Console" 標籤

3. **執行測試流程**
   ```
   ✅ 登入您的帳號
   ✅ 玩一局遊戲直到結束
   ✅ 查看個人統計頁面
   ✅ 查看排行榜
   ✅ 登出再重新登入
   ```

4. **觀察控制台日誌**
   - 尋找 `🔍 [DEBUG] 開始查詢用戶遊戲記錄` 信息
   - 確認是否有 `✅ [DEBUG] 遊戲記錄查詢成功` 或 `✅ [DEBUG] 降級查詢成功`
   - 檢查是否還有索引錯誤

### 長期解決方案（建立索引）

如果您希望獲得最佳性能，請參考 `FIRESTORE_INDEX_SETUP.md` 建立索引。

## 📋 預期結果

### 修復後應該看到：

1. **成功的查詢日誌**
   ```
   🔍 [DEBUG] 開始查詢用戶遊戲記錄: {userId: "xxx", limitCount: 50}
   ✅ [DEBUG] 遊戲記錄查詢成功: {totalFound: 2, returned: 2}
   ```

2. **歷史記錄正常顯示**
   - 個人統計頁面顯示遊戲記錄
   - 重新登入後歷史記錄保留

3. **排行榜正常工作**
   - 遊戲結束後排行榜更新
   - 顯示您的成績

### 如果仍有問題：

1. **檢查降級查詢**
   ```
   🔄 [DEBUG] 嘗試降級查詢...
   ✅ [DEBUG] 降級查詢成功: {totalFound: X, returned: Y}
   ```

2. **檢查數據同步**
   ```
   ☁️ 開始同步數據到雲端...
   ✅ 數據同步到雲端成功
   ```

## 🚨 故障排除

### 如果歷史記錄仍然為空：

1. **檢查用戶認證**
   ```javascript
   // 在控制台執行
   console.log('當前用戶:', window.userStore?.getState?.()?.currentUser);
   ```

2. **檢查本地存儲**
   ```javascript
   // 在控制台執行
   console.log('本地遊戲記錄:', localStorage.getItem('user-store'));
   ```

3. **手動觸發同步**
   ```javascript
   // 在控制台執行
   window.userStore?.getState?.()?.loadFromCloud?.();
   ```

### 如果排行榜為空：

1. **檢查遊戲結束流程**
   - 確認看到 `🎮 [DEBUG] 遊戲結束，開始處理數據...`
   - 確認看到 `🏆 [DEBUG] 準備更新排行榜`

2. **檢查排行榜數據**
   - 進入排行榜頁面
   - 查看是否有載入日誌

## 📞 需要幫助？

如果問題持續存在，請提供：

1. **完整的控制台日誌**（從登入到遊戲結束）
2. **瀏覽器和版本信息**
3. **網路連接狀態**
4. **Firebase 專案配置是否正確**

## 🎯 總結

這次修復主要解決了：
- ✅ Firestore 索引依賴問題
- ✅ 查詢失敗的降級處理
- ✅ 歷史記錄載入問題
- ✅ 排行榜數據同步問題
- ✅ 重新登入後數據丟失問題

現在系統應該能夠在沒有索引的情況下正常工作，同時提供了建立索引的指南以獲得最佳性能。